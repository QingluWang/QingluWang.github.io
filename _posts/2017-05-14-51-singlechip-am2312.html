---
layout: post
status: publish
published: true
title: 51单片机与AM2321B温湿度传感器通信
author:
  display_name: Garlic
  login: wangqinglu
  email: 1119543546@qq.com
  url: ''
author_login: wangqinglu
author_email: 1119543546@qq.com
wordpress_id: 162
wordpress_url: http://blog.wql970522.top/?p=162
date: '2017-05-14 12:31:04 +0800'
date_gmt: '2017-05-14 04:31:04 +0800'
categories:
- C/C++
tags: []
comments: []
---
<p>一、器件</p>
<p>1、STC90C516RD+单片机</p>
<p>2、LCD1602A液晶显示屏</p>
<p>3、奥松AM2312B温湿度传感器</p>
<p>二、目的</p>
<p>熟悉I2C总线通信协议</p>
<p>三、准备</p>
<p>1、I2C总线协议</p>
<p>a、组成</p>
<p>串行数据线SDA</p>
<p>串行时钟线SCL</p>
<p>b、&nbsp;位传输</p>
<p>在时钟线SCL 的高电平期间，数据线SDA 为低电平表示当前传输逻辑电平&ldquo; 0&rdquo;；在时钟线SCL 的高电平期间，数据线SDA 为<br />
高电平表示当前传输逻辑电平&ldquo; 1&rdquo;。</p>
<p><strong><em>即SCL高电平期间，进行SDA逻辑电平传输</em></strong></p>
<p>c、 数据的有效性（电平有效非上升沿或下降沿有效）</p>
<p>数据线SDA 的数据必须在时钟的高电平周期保持稳定不变。数据线SDA 的高或低电平状态只有<br />
在时钟线SCL 处于低电平期间才允许改变。但是在I2C总线的起始和结束时例外。</p>
<p><strong><em>即SCL低电平期间，可进行SDA电平调整</em></strong></p>
<p>d、 起始和停止条件</p>
<p>起始条件：当SCL处于高电平期间时， SDA从高电平向低电平跳变时产生起始条件。总线在起始<br />
条件产生后便处于忙的状态。起始条件常常简记为S。<br />
停止条件：当SCL处于高电平期间时， SDA从低电平向高电平跳变时产生停止条件。总线在停止<br />
条件产生后处于空闲状态。停止条件简记为P。</p>
<p><img class="alignnone size-medium wp-image-166" src="http://blog.wql970522.top/wp-content/uploads/2017/05/捕获-300x81.png" alt="" width="300" height="81" /></p>
<p>e、 字节传输格式</p>
<p>I2C 总线以字节为单位收发数据。传输到SDA线上的每个字节必须为8位。每次传输的字节数量</p>
<p>不受限制。首先传输的是数据的最高位（MSB 第7位），最后传输的是最低位（LSB，第0位）。另外<br />
<strong><em>每个字节后必须跟一个响应位</em></strong>（ACK）。</p>
<p>f、 I2C 总线响应</p>
<p><strong><em> 主机向从机发送数据时，应答位（ACK）由从机产生；主机从从机接收数据时，应答位（ACK）由主机产生。</em></strong></p>
<p>I2C总线标准规定：应答位为0表示接收器应答（ACK），常常简记为A；为1则表示非应答（NACK），<br />
常简记为NA。<strong><em>发送器发送LSB之后，应当释放SDA线（拉高SDA），以等待接收器产生应答位。</em></strong><br />
如果接收器在接收完最后一个字节的数据，或者不能再接收更多的数据时，应当产生非应答信<br />
号来通知发送器。发送器如果发现接收器产生了非应答状态，则应当终止发送。</p>
<p>g、 从机地址</p>
<p>I2C 总线的寻址过程是通常在起始条件后的<strong><em>第一个字节</em></strong>决定了主机选择哪一个从机，即7位寻址地址，然后再加1位最低位LSB,</p>
<p>LSB=1,主机向从机读信息；LSB=0,主机会写信息到被选中的从机。</p>
<p>2、 I2C_ModBus通信协议</p>
<p>a、概述</p>
<p>AM2321 的串行接口为 I2C 总线，完全按照 I2C 标准协议编址，可直接挂在 I2C 总线上。 AM2321</p>
<p>传感器的 I2C 的地址（SLAVE ADDRESS）为 0xB8，在 I2C 标准总线的协议基础上，基于 ModBus<br />
协议，制定了独有的通信协议，降低了传输误码率。</p>
<p>b、通讯数据（信息帧）格式</p>
<p>数据格式： I2C 地址+R/W--功能码--数据区--CRC校验</p>
<p>数据长度： 1 个字节--1 个字节--Ｎ个字节--16 位 CRC 码（冗余循环码）</p>
<p>c、通讯信息传输过程</p>
<p>当通讯命令由发送设备（主机）发送至传感器时，符合传感器 I2C 地址的命令，传感器才进行<br />
接收，并根据功能码及相关要求读取信息；然后把执行结果（数据）返送给主机。返回的信息中包<br />
括功能码、执行后的数据以及 CRC 校验码（用户可不读取其 CRC， 可直接发送停止条件）。</p>
<p>d、 通讯 I2C 从机地址</p>
<p>0xB8（此处51单片机做主机，AM2321B做从机）</p>
<p>e、 通讯 I2C 的功能码</p>
<p>功能码是每次通讯信息帧传送的第一个字节。 I2C_ModBus 通讯规则， 可定义的功能码为 1 到<br />
127。作为主机请求发送，通过功能码告诉从机应执行什么动作。作为从机响应，从机返回的功能<br />
码与从主机发送来的功能码一样， 则表明从机已响应主机并且已进行相关的操作。</p>
<p>0x03--读寄存器数据</p>
<p>0x10--写多路寄存器</p>
<p>f、 通讯 I2C 的数据区</p>
<p>数据区包括需要由传感器返回何种信息或执行什么动作。 主机利用通讯命令（功能码03），可以任意读取其<br />
数据寄存器， 传感器的数据寄存器存储了温湿度值及传感器相应设备信息<br />
及其他相关信号； 每个数据寄存器是单字节（8个位） 的二进制数据； 一次最多可读取传感器的10<br />
个寄存器的数据，超过读取长度，传感器会返回相应错误代码。<br />
g、 温度输出格式</p>
<p>温度分辨率是 16Bit，温度最高位（Bit15）等于 1 表示负温度，温度最高位（Bit15）等于 0<br />
表示正温度；温度除了最高位（Bit14~Bit0）表示传感器串出的温度值。传感器串出的温度值是<br />
实际温度值的 10 倍；</p>
<p>四、操作</p>
<p>a、&nbsp;主机唤醒传感器</p>
<p>I2C启动</p>
<p>按字节发送AM2321B器件地址</p>
<p>发送检测ACK的时钟,此时传感器不会返回ACK,但是第一定要发检测ACK的时钟 否则会出错</p>
<p>延时>800us(手册里提到)</p>
<p>I2C停止</p>
<p>b、&nbsp;主机发送读指令或发送写指令</p>
<p>I2C启动</p>
<p>发送AM2321B器件地址</p>
<p>检测ACK,为0开始发送指令，为1结束发送指令</p>
<p>开始按字节发送指令</p>
<p>检测ACK,为0继续发送指令，为1结束发送指令</p>
<p>I2C停止</p>
<p>c、&nbsp;主机读返回数据或确认信号</p>
<p>I2C启动</p>
<p>发送AM2321B器件地址</p>
<p>延时>30us</p>
<p>开始按字节读取数据</p>
<p>添加ACK应答</p>
<p>I2C停止</p>
<p>d、释放I2C总线</p>
<p>e、LCD1602A显示</p>
<p>五、效果</p>
<p><img class=" wp-image-175" src="http://blog.wql970522.top/wp-content/uploads/2017/05/IMG_20170514_122756-e1494736615398-300x225.jpg" alt="" width="501" height="376" /></p>
<p>六、参考资料</p>
<p>奥松AM2321温湿度模块-最小温湿度模块-高精度温湿度传感器中文手册</p>
