---
layout	:	post
title	:	51单片机与AM2321B温湿度传感器通信
---
## 器件

<blockquote>
1、STC90C516RD+单片机<br>
2、LCD1602A液晶显示屏<br>
3、奥松AM2312B温湿度传感器
</blockquote>

## 概述

### I2C总线协议

#### 1.组成

串行数据线SDA

串行时钟线SCL

#### 2.位传输

在时钟线SCL 的高电平期间，数据线SDA 为低电平表示当前传输逻辑电平“ 0”；在时钟线SCL 的高电平期间，数据线SDA 为
高电平表示当前传输逻辑电平“ 1”。

即SCL高电平期间，进行SDA逻辑电平传输

#### 3.数据的有效性（电平有效非上升沿或下降沿有效）

数据线SDA 的数据必须在时钟的高电平周期保持稳定不变。数据线SDA 的高或低电平状态只有
在时钟线SCL 处于低电平期间才允许改变。但是在I2C总线的起始和结束时例外。

即SCL低电平期间，可进行SDA电平调整

#### 4.起始和停止条件

起始条件：当SCL处于高电平期间时， SDA从高电平向低电平跳变时产生起始条件。总线在起始
条件产生后便处于忙的状态。起始条件常常简记为S。
停止条件：当SCL处于高电平期间时， SDA从低电平向高电平跳变时产生停止条件。总线在停止
条件产生后处于空闲状态。停止条件简记为P。

#### 5.字节传输格式

I2C 总线以字节为单位收发数据。传输到SDA线上的每个字节必须为8位。每次传输的字节数量

不受限制。首先传输的是数据的最高位（MSB 第7位），最后传输的是最低位（LSB，第0位）。另外
每个字节后必须跟一个响应位（ACK）。

#### 6.I2C 总线响应

主机向从机发送数据时，应答位（ACK）由从机产生；主机从从机接收数据时，应答位（ACK）由主机产生。

I2C总线标准规定：应答位为0表示接收器应答（ACK），常常简记为A；为1则表示非应答（NACK），
常简记为NA。发送器发送LSB之后，应当释放SDA线（拉高SDA），以等待接收器产生应答位。
如果接收器在接收完最后一个字节的数据，或者不能再接收更多的数据时，应当产生非应答信
号来通知发送器。发送器如果发现接收器产生了非应答状态，则应当终止发送。

#### 7.从机地址

I2C 总线的寻址过程是通常在起始条件后的第一个字节决定了主机选择哪一个从机，即7位寻址地址，然后再加1位最低位LSB,

LSB=1,主机向从机读信息；LSB=0,主机会写信息到被选中的从机。

### 2.I2C_ModBus通信协议

#### 1.概述

AM2321 的串行接口为 I2C 总线，完全按照 I2C 标准协议编址，可直接挂在 I2C 总线上。 AM2321

传感器的 I2C 的地址（SLAVE ADDRESS）为 0xB8，在 I2C 标准总线的协议基础上，基于 ModBus
协议，制定了独有的通信协议，降低了传输误码率。

#### 2.通讯数据（信息帧）格式

数据格式： I2C 地址+R/W–功能码–数据区–CRC校验

数据长度： 1 个字节–1 个字节–Ｎ个字节–16 位 CRC 码（冗余循环码）

#### 3.通讯信息传输过程

当通讯命令由发送设备（主机）发送至传感器时，符合传感器 I2C 地址的命令，传感器才进行
接收，并根据功能码及相关要求读取信息；然后把执行结果（数据）返送给主机。返回的信息中包
括功能码、执行后的数据以及 CRC 校验码（用户可不读取其 CRC， 可直接发送停止条件）。

#### 4.通讯 I2C 从机地址

0xB8（此处51单片机做主机，AM2321B做从机）

#### 5.通讯 I2C 的功能码

功能码是每次通讯信息帧传送的第一个字节。 I2C_ModBus 通讯规则， 可定义的功能码为 1 到
127。作为主机请求发送，通过功能码告诉从机应执行什么动作。作为从机响应，从机返回的功能
码与从主机发送来的功能码一样， 则表明从机已响应主机并且已进行相关的操作。

0x03–读寄存器数据

0x10–写多路寄存器

#### 6.通讯 I2C 的数据区

数据区包括需要由传感器返回何种信息或执行什么动作。 主机利用通讯命令（功能码03），可以任意读取其
数据寄存器， 传感器的数据寄存器存储了温湿度值及传感器相应设备信息
及其他相关信号； 每个数据寄存器是单字节（8个位） 的二进制数据； 一次最多可读取传感器的10
个寄存器的数据，超过读取长度，传感器会返回相应错误代码。
#### 7.温度输出格式

温度分辨率是 16Bit，温度最高位（Bit15）等于 1 表示负温度，温度最高位（Bit15）等于 0
表示正温度；温度除了最高位（Bit14~Bit0）表示传感器串出的温度值。传感器串出的温度值是
实际温度值的 10 倍；

## 操作

### 1.主机唤醒传感器
<blockquote>
I2C启动<br>
按字节发送AM2321B器件地址<br>
发送检测ACK的时钟,此时传感器不会返回ACK,但是第一定要发检测ACK的时钟 否则会出错<br>
延时>800us(手册里提到)<br>
I2C停止<br>
</blockquote>
### 2.主机发送读指令或发送写指令
<blockquote>
I2C启动<br>
发送AM2321B器件地址<br>
检测ACK,为0开始发送指令，为1结束发送指令<br>
开始按字节发送指令<br>
检测ACK,为0继续发送指令，为1结束发送指令<br>
I2C停止<br>
</blockquote>
### 3.主机读返回数据或确认信号
<blockquote>
I2C启动<br>
发送AM2321B器件地址<br>
延时>30us<br>
开始按字节读取数据<br>
添加ACK应答<br>
I2C停止<br>
</blockquote>
### 4.释放I2C总线

### 5.LCD1602A显示

## 效果